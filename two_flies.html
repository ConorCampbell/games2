<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two Flies: High Stakes Racing</title>
    <style>
        /* --- RESET & BASICS --- */
        :root {
            --neon-green: #39ff14;
            --neon-red: #ff073a;
            --glass-bg: rgba(20, 20, 20, 0.85);
            --wall-color: #e0e0e0;
            --buzz-speed: 0.08s
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            background-color: #1a1a1a;
            color: white;
            height: 100vh;
            display: flex;
            justify-content: center;
            user-select: none; /* Prevent text selection */
        }

        
        .background-container {
    /* Set the container position to relative so the pseudo-element can be positioned absolutely within it */
    position: relative;
    height: 100vh;
    width: 100%;    
    /* Ensure the content is above the pseudo-element background */
    z-index: 1; 
    
    /* Optional: Style the content */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    text-shadow: 1px 1px 3px black;
}

.background-container::before {
    content: ""; /* Required for pseudo-elements */
    background-image: url('static/img/two-flies2.jpg');
    background-size: cover;
    background-position: center;
    
    /* Position and size the pseudo-element to cover the container */
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    
    /* Place the pseudo-element behind the main content */
    z-index: -1; 
    
    /* Apply grayscale and blur effects here */
    filter: grayscale(50%) blur(4px);
}



        /* --- THE WALL (Game Board) --- */
        #game-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 100%;
            background: 
                linear-gradient(rgba(0,0,0,0.1), rgba(0,0,0,0.4)),
                url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100" height="100" filter="url(%23noise)" opacity="0.4"/></svg>'),
                #d3d3d3; 
            background-size: cover, 200px 200px, cover;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        #confetti-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 250; /* Above UI, below Modal */
        }

        /* --- FINISH LINE --- */
        #finish-line {
            position: absolute;
            top: 10%;
            width: 100%;
            height: 20px;
            background: repeating-linear-gradient(45deg, #ffcc00, #ffcc00 10px, #000 10px, #000 20px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 1;
        }

        #finish-label {
            position: absolute;
            top: 7%;
            width: 100%;
            text-align: center;
            font-weight: 900;
            color: rgba(0,0,0,0.5);
            text-transform: uppercase;
            letter-spacing: 5px;
            font-size: 1.5rem;
        }

        /* --- THE FLIES --- */
        .fly-lane {
            position: absolute;
            bottom: 0; top: 0;
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: flex-end; 
        }
        
        #lane-1 { left: 0; border-right: 1px dashed rgba(0,0,0,0.1); }
        #lane-2 { right: 0; }

        .fly {
            font-size: 2.5rem; 
            position: absolute;
            bottom: 20px; 
            right:50%;
            transition: right, bottom 0.1s ease-in-out, transform 0.05s ease;
            filter: drop-shadow(5px 10px 4px rgba(0,0,0,0.4));
            z-index: 10;
        }

        .fly-name {
            position: absolute;
            bottom: -30px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            background: rgba(255,255,255,0.8);
            padding: 2px 8px;
            border-radius: 10px;
            white-space: nowrap;
        }

        /* Animation for buzzing */
        @keyframes buzz {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            25% { transform: translate(-2px, 0px) rotate(2deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            75% { transform: translate(2px, 1px) rotate(-2deg); }
            100% { transform: translate(0px, -2px) rotate(0deg); }
        }
        .buzzing { animation: buzz var(--buzz-speed) infinite; }

        /* --- UI OVERLAY --- */
        #ui-layer {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            z-index: 100;
        }

        /* Header HUD */
        #hud {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            pointer-events: all;
        }

        .bankroll {
            background: rgba(0,0,0,0.6);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #444;
            font-weight: bold;
            color: var(--neon-green);
        }

        /* Sound Toggle */
        #sound-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background 0.2s;
        }
        #sound-toggle:hover { background: rgba(255,255,255,0.3); }

        /* Betting Panel */
        #betting-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.2);
            padding: 20px;
            pointer-events: all;
            border-radius: 20px 20px 0 0;
            transition: transform 0.3s ease;
        }

        .panel-hidden { transform: translateY(110%); }

        h2 { margin: 0 0 15px 0; font-size: 1.2rem; text-transform: uppercase; color: #aaa; text-align: center;}

        .card-container { display: flex; gap: 15px; margin-bottom: 20px; }

        .fly-card {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fly-card:hover { background: rgba(255,255,255,0.1); }
        .fly-card.selected {
            border-color: var(--neon-green);
            background: rgba(57, 255, 20, 0.1);
        }

        .odds-display {
            font-size: 1.5rem;
            font-weight: 800;
            display: block;
            margin-top: 5px;
        }
        .odds-up { color: var(--neon-green); }
        .odds-down { color: var(--neon-red); }

        .controls { display: flex; gap: 10px; align-items: center; justify-content: center; }

        input[type="number"] {
            background: #333; border: 1px solid #555;
            color: white; padding: 12px; border-radius: 8px;
            font-size: 1rem; width: 80px; text-align: center;
        }

        button.btn-primary {
            background: var(--neon-green); color: black;
            border: none; padding: 12px 30px; border-radius: 8px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            text-transform: uppercase; flex-grow: 1;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.4);
        }
        button.btn-primary:disabled {
            background: #555; color: #888; cursor: not-allowed; box-shadow: none;
        }

        /* --- COUNTDOWN & ALERTS --- */
        #overlay-message {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem; font-weight: 900;
            text-shadow: 0 0 20px black;
            pointer-events: none; display: none;
            z-index: 200;
        }
        
        /* --- WINNER MODAL --- */
        #winner-modal {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 300; display: none;
            backdrop-filter: blur(5px);
        }

        #winner-modal h1 { font-size: 3rem; margin-bottom: 10px; text-shadow: 0 0 20px currentColor; }
        #payout-info { font-size: 1.5rem; margin-bottom: 30px; text-align: center; line-height: 1.5; }
        
        .btn-restart {
            background: white; color: black; border: none;
            padding: 15px 40px; font-size: 1.2rem;
            font-weight: bold; border-radius: 50px; cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-restart:hover { transform: scale(1.05); }

        .fly-avatar{
            font-size:2rem;
        }
        
    </style>
</head>
<body>

<div id="game-container" class="background-container">
    <canvas id="confetti-canvas"></canvas>
    <div id="finish-label">Finish Line</div>
    <div id="finish-line"></div>

    <div id="ui-layer">
        <div id="hud">
            <div id="sound-toggle" onclick="toggleSound()">ðŸ”‡</div>
            <div class="bankroll">BANK: $<span id="bank-val">100.00</span></div>
        </div>

        <div id="overlay-message">3</div>

        <div id="betting-panel">
            <h2>Place Your Bet</h2>
            <div class="card-container">
                <div class="fly-card" id="card-1" onclick="selectFly(1)">
                    <div class="fly-avatar buzzing">ðŸª°</div>
                    <div class="fly-title">Marty McFly</div>
                    <span class="odds-display" id="odds-1">1.90</span>
                </div>
                <div class="fly-card" id="card-2" onclick="selectFly(2)">
                    <div class="fly-avatar buzzing" style="filter: hue-rotate(90deg);">ðŸª°</div>
                    <div class="fly-title">Buzz Aldrin</div>
                    <span class="odds-display" id="odds-2">1.90</span>
                </div>


                <svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
  <g transform="translate(50, 50) scale(0.9)">
    <g stroke="#222" stroke-width="0.8" fill="none" opacity="0.7">
      <path d="M-3,-5 C-8,-8 -12,-5 -15,-8" />
      <path d="M3,-5 C8,-8 12,-5 15,-8" />
      <path d="M-3,2 C-9,4 -14,8 -16,12" />
      <path d="M3,2 C9,4 14,8 16,12" />
      <path d="M-2,10 C-6,15 -10,20 -12,25" />
      <path d="M2,10 C6,15 10,20 12,25" />
    </g>

    <g fill="#333" stroke="#111" stroke-width="0.5">
      <ellipse cx="0" cy="12" rx="9" ry="14" fill="url(#abdomenGrad)" />
      <ellipse cx="0" cy="-6" rx="8" ry="9" fill="url(#thoraxGrad)" />
      <path d="M-3,-10 L-2,0 M3,-10 L2,0" stroke="#111" stroke-width="1.5" opacity="0.6"/>
      <circle cx="0" cy="-18" r="6" fill="#444" />
    </g>

    <g fill="url(#eyeGrad)">
      <circle cx="-4" cy="-19" r="3.5" />
      <circle cx="4" cy="-19" r="3.5" />
    </g>
    <g stroke="#500" stroke-width="0.2" opacity="0.3" fill="none">
      <path d="M-6,-21 C-5,-17 -3,-17 -2,-21 M6,-21 C5,-17 3,-17 2,-21"/>
      <path d="M-7,-19 C-4,-18 -4,-20 -7,-21 M7,-19 C4,-18 4,-20 7,-21"/>
    </g>

    <g fill="rgba(220, 235, 255, 0.3)" stroke="#777" stroke-width="0.4">
      <path d="M-4,-8 C-12,-20 -18,-5 -12,25 C-8,28 -2,25 -2,15 C-2,5 -3,0 -4,-8 Z" />
      <path d="M4,-8 C12,-20 18,-5 12,25 C8,28 2,25 2,15 C2,5 3,0 4,-8 Z" />
    </g>
    <g stroke="#666" stroke-width="0.3" fill="none" opacity="0.5">
      <path d="M-5,-6 C-10,5 -10,20 -8,26" />
      <path d="M5,-6 C10,5 10,20 8,26" />
    </g>
    
    <path d="M-1,-23 L-1.5,-26 M1,-23 L1.5,-26" stroke="#333" stroke-width="0.6" />
  </g>

  <defs>
    <radialGradient id="thoraxGrad" cx="0.5" cy="0.5" r="0.5" fx="0.5" fy="0.3">
      <stop offset="0%" stop-color="#666" />
      <stop offset="100%" stop-color="#222" />
    </radialGradient>
    <radialGradient id="abdomenGrad" cx="0.5" cy="0.5" r="0.5" fx="0.5" fy="0.5">
      <stop offset="0%" stop-color="#776a5c" />
      <stop offset="100%" stop-color="#443d35" />
    </radialGradient>
    <radialGradient id="eyeGrad" cx="0.5" cy="0.5" r="0.6" fx="0.3" fy="0.3">
      <stop offset="0%" stop-color="#a54" />
      <stop offset="80%" stop-color="#622" />
      <stop offset="100%" stop-color="#411" />
    </radialGradient>
  </defs>
</svg>

                
            </div>

            <div class="controls">
                <input type="number" id="wager-input" value="10" min="1" max="1000">
                <button id="btn-place-bet" class="btn-primary" onclick="placeBet()">LOCK BET & RACE</button>
            </div>
            <div style="text-align:center; margin-top:10px; font-size:0.8rem; color:#666;" id="status-text">Select a fly to start</div>
        </div>
    </div>

    <div id="winner-modal">
        <h1 id="winner-title">WINNER!</h1>
        <div id="payout-info">You won $0.00</div>
        <button class="btn-restart" onclick="resetGame()">RACE AGAIN</button>
    </div>

    <div class="fly-lane" id="lane-1">
        <div class="fly" id="fly-1">ðŸª°<div class="fly-name">Marty</div></div>
    </div>
    <div class="fly-lane" id="lane-2">
        <div class="fly" id="fly-2" style="filter: drop-shadow(5px 10px 4px rgba(0,0,0,0.4)) hue-rotate(90deg);">ðŸª°<div class="fly-name">Buzz</div></div>
    </div>
</div>

<script>
    // --- AUDIO SYSTEM (Web Audio API) ---
    const AudioEngine = {
        ctx: null,
        isMuted: true, // Start muted by default to respect browser policies
        buzzOsc1: null,
        buzzOsc2: null,
        buzzGain: null,

        init: function() {
            if (!this.ctx) {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (this.ctx.state === 'suspended') {
                this.ctx.resume();
            }
        },

        toggle: function() {
            this.init();
            this.isMuted = !this.isMuted;
            const btn = document.getElementById('sound-toggle');
            btn.innerText = this.isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
            return this.isMuted;
        },

        playTone: function(freq, type, duration, vol=0.1) {
            if(this.isMuted || !this.ctx) return;
            
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            
            osc.start();
            osc.stop(this.ctx.currentTime + duration);
        },

        playCountdown: function(isGo) {
            if (isGo) {
                // High pitch for GO
                this.playTone(880, 'square', 0.6, 0.15);
            } else {
                // Low pitch for numbers
                this.playTone(440, 'triangle', 0.3, 0.1);
            }
        },

        playWin: function(isWin) {
            if(this.isMuted || !this.ctx) return;
            // Arpeggio
            const now = this.ctx.currentTime;
            const type = isWin ? 'triangle' : 'sawtooth';
            const notes = isWin ? [523.25, 659.25, 783.99, 1046.50] : [300, 250, 200]; // C Major vs descending
            
            notes.forEach((freq, i) => {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.1, now + (i * 0.1));
                gain.gain.linearRampToValueAtTime(0, now + (i * 0.1) + 0.3);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(now + (i * 0.1));
                osc.stop(now + (i * 0.1) + 0.4);
            });
        },

        startBuzz: function() {
            if(this.isMuted || !this.ctx) return;

            // Create two oscillators for a dissonant, buzzing sound
            this.buzzOsc1 = this.ctx.createOscillator();
            this.buzzOsc2 = this.ctx.createOscillator();
            this.buzzGain = this.ctx.createGain();

            this.buzzOsc1.type = 'sawtooth';
            this.buzzOsc2.type = 'sawtooth';

            // Base frequencies (Fly buzzing is around 200Hz)
            this.buzzOsc1.frequency.value = 170;
            this.buzzOsc2.frequency.value = 180; // Slight detune for "beating" effect

            this.buzzGain.gain.value = 0.01;

            // LFO to wobble the pitch slightly
            const lfo = this.ctx.createOscillator();
            lfo.frequency.value = 22; // 8Hz wobble
            const lfoGain = this.ctx.createGain();
            lfoGain.gain.value = 1; // Strength of wobble

            lfo.connect(lfoGain);
            lfoGain.connect(this.buzzOsc1.frequency);

            this.buzzOsc1.connect(this.buzzGain);
            this.buzzOsc2.connect(this.buzzGain);
            this.buzzGain.connect(this.ctx.destination);

            this.buzzOsc1.start();
            this.buzzOsc2.start();
            lfo.start();
        },

        stopBuzz: function() {
            if (this.buzzGain) {
                // Fade out to avoid clicking
                this.buzzGain.gain.setTargetAtTime(0, this.ctx.currentTime, 0.1);
            }
            if (this.buzzOsc1) {
                setTimeout(() => {
                    this.buzzOsc1.stop();
                    this.buzzOsc2.stop();
                    this.buzzOsc1 = null;
                }, 200);
            }
        }
    };

    // --- CONFETTI SYSTEM (Canvas) ---
    const Confetti = {
        canvas: document.getElementById('confetti-canvas'),
        ctx: document.getElementById('confetti-canvas').getContext('2d'),
        particles: [],
        isActive: false,

        resize: function() {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
        },

        start: function() {
            this.resize();
            this.isActive = true;
            this.particles = [];
            const colors = ['#39ff14', '#ff0000', '#00ffff', '#ffff00', '#ff00ff'];
            
            for(let i=0; i<150; i++) {
                this.particles.push({
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height - this.canvas.height, // Start above
                    w: Math.random() * 10 + 5,
                    h: Math.random() * 10 + 5,
                    dx: Math.random() * 4 - 2,
                    dy: Math.random() * 5 + 2,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    tilt: Math.random() * 10,
                    tiltAngle: Math.random()
                });
            }
            this.animate();
        },

        stop: function() {
            this.isActive = false;
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        },

        animate: function() {
            if(!this.isActive) return;
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            
            this.particles.forEach(p => {
                p.tiltAngle += 0.1;
                p.y += p.dy;
                p.x += Math.sin(p.tiltAngle) * 2;

                this.ctx.fillStyle = p.color;
                this.ctx.beginPath();
                this.ctx.rect(p.x, p.y, p.w, p.h);
                this.ctx.fill();

                // Recycle particles
                if(p.y > this.canvas.height) {
                    p.y = -20;
                    p.x = Math.random() * this.canvas.width;
                }
            });
            requestAnimationFrame(() => this.animate());
        }
    };

    // --- STATE VARIABLES ---
    let bankroll = 100.00;
    let selectedFly = null;
    let odds1 = 1.90;
    let odds2 = 1.90;
    let wager = 0;
    let isRacing = false;
    let oddsInterval;

    // DOM Elements
    const fly1 = document.getElementById('fly-1');
    const fly2 = document.getElementById('fly-2');
    const elOdds1 = document.getElementById('odds-1');
    const elOdds2 = document.getElementById('odds-2');
    const elBank = document.getElementById('bank-val');
    const btnBet = document.getElementById('btn-place-bet');
    const bettingPanel = document.getElementById('betting-panel');
    const overlayMsg = document.getElementById('overlay-message');
    const modal = document.getElementById('winner-modal');
    const statusText = document.getElementById('status-text');

    // --- INITIALIZATION ---
    updateBankDisplay();
    startOddsSimulation();

    // --- LOGIC ---

    function toggleSound() {
        AudioEngine.toggle();
    }

    function startOddsSimulation() {
        oddsInterval = setInterval(() => {
            if(isRacing) return;
            const shift = (Math.random() - 0.5) * 0.1;
            let newOdds1 = Math.max(1.5, Math.min(3.0, odds1 - shift));
            let newOdds2 = Math.max(1.5, Math.min(3.0, odds2 + shift));
            updateOddsDisplay(elOdds1, odds1, newOdds1);
            updateOddsDisplay(elOdds2, odds2, newOdds2);
            odds1 = newOdds1;
            odds2 = newOdds2;
        }, 1500);
    }

    function updateOddsDisplay(element, oldVal, newVal) {
        element.innerText = newVal.toFixed(2);
        element.className = 'odds-display ' + (newVal > oldVal ? 'odds-up' : 'odds-down');
        setTimeout(() => element.className = 'odds-display', 500);
    }

    function selectFly(id) {
        if(isRacing) return;
        
        // Init Audio Context on first interaction
        AudioEngine.init();

        selectedFly = id;
        document.querySelectorAll('.fly-card').forEach(c => c.classList.remove('selected'));
        document.getElementById(`card-${id}`).classList.add('selected');
        statusText.innerText = `Betting on ${id === 1 ? 'Marty' : 'Buzz'}`;
        btnBet.disabled = false;
    }

    function placeBet() {
        const inputVal = parseFloat(document.getElementById('wager-input').value);
        if(!selectedFly) { alert("Please select a fly first!"); return; }
        if(isNaN(inputVal) || inputVal <= 0) { alert("Invalid wager amount."); return; }
        if(inputVal > bankroll) { alert("Insufficient funds!"); return; }

        wager = inputVal;
        bankroll -= wager;
        updateBankDisplay();
        startRaceSequence();
    }

    function startRaceSequence() {
        isRacing = true;
        clearInterval(oddsInterval);
        bettingPanel.classList.add('panel-hidden');
        btnBet.disabled = true;

        let count = 3;
        overlayMsg.style.display = 'block';
        overlayMsg.innerText = count;
        
        AudioEngine.playCountdown(false); // First Beep

        const countInt = setInterval(() => {
            count--;
            if(count > 0) {
                overlayMsg.innerText = count;
                AudioEngine.playCountdown(false); // 2, 1 Beeps
                overlayMsg.style.color = "white";
            } else if (count === 0) {
                overlayMsg.innerText = "GO!";
                overlayMsg.style.color = "var(--neon-green)";
                AudioEngine.playCountdown(true); // GO Beep
            } else {
                clearInterval(countInt);
                overlayMsg.style.display = 'none';
                runRace();
            }
        }, 800);
    }

    function runRace() {
        fly1.classList.add('buzzing');
        fly2.classList.add('buzzing');
        AudioEngine.startBuzz();

        let pos1 = 20;
        let pos2 = 20;
        
        let x1 = 50;
        let x2 = 50;
        
        const finishLine = document.getElementById('game-container').offsetHeight * 0.85;

        const raceInt = setInterval(() => {
            // Movement physics
            pos1 += (Math.random() * 4) + (Math.random() > 0.9 ? 25 * Math.random() : 0); 
            pos2 += (Math.random() * 4) + (Math.random() > 0.9 ? 25 * Math.random() : 0);

            x1 += 3* (Math.random() -.5) ;
            x2 += 3* (Math.random() -.5) ;
            
            
            if(Math.random() > 0.95) pos1 -= 4 * Math.random(); 
            if(Math.random() > 0.95) pos2 -= 4 * Math.random();

            fly1.style.right = x1 + '%';
            fly2.style.right = x2 + '%';

            fly1.style.bottom = pos1 + 'px';
            fly2.style.bottom = pos2 + 'px';

            if (pos1 >= finishLine || pos2 >= finishLine) {
                clearInterval(raceInt);
                fly1.classList.remove('buzzing');
                fly2.classList.remove('buzzing');
                AudioEngine.stopBuzz();
                
                const winnerId = pos1 > pos2 ? 1 : 2;
                handleWin(winnerId);
            }
        }, 50);
    }

    function handleWin(winnerId) {
        const winnerName = winnerId === 1 ? "MARTY MCFLY" : "BUZZ ALDRIN";
        const playerWon = (winnerId === selectedFly);
        
        let payout = 0;
        let titleText = "";
        let payoutText = "";
        let titleColor = "";

        if (playerWon) {
            const finalOdds = (winnerId === 1) ? odds1 : odds2;
            payout = wager * finalOdds;
            bankroll += payout;
            titleText = "YOU WON!";
            payoutText = `${winnerName} takes it! <br> Payout: $${payout.toFixed(2)}`;
            titleColor = "var(--neon-green)";
            Confetti.start(); // CONFETTI TRIGGER
            AudioEngine.playWin(true);
        } else {
            titleText = "YOU LOST";
            payoutText = `${winnerName} takes it. <br> Better luck next time.`;
            titleColor = "var(--neon-red)";
            AudioEngine.playWin(false);
        }

        setTimeout(() => {
            const t = document.getElementById('winner-title');
            t.innerText = titleText;
            t.style.color = titleColor;
            document.getElementById('payout-info').innerHTML = payoutText;
            modal.style.display = 'flex';
            updateBankDisplay();
        }, 500);
    }

    function resetGame() {
        Confetti.stop();
        modal.style.display = 'none';
        fly1.style.bottom = '20px';
        fly2.style.bottom = '20px';
        isRacing = false;
        selectedFly = null;
        wager = 0;
        document.querySelectorAll('.fly-card').forEach(c => c.classList.remove('selected'));
        statusText.innerText = "Select a fly to start";
        bettingPanel.classList.remove('panel-hidden');
        
        if(bankroll < 1) {
            alert("You are bankrupt! Stimulus check: $100.");
            bankroll = 100;
            updateBankDisplay();
        }

        startOddsSimulation();
    }

    function updateBankDisplay() {
        elBank.innerText = bankroll.toFixed(2);
    }
</script>

</body>
</html>
